# Release workflow for Monokai Islands Theme
# Triggers daily at 3 AM UTC or manually, creates releases using semantic-release

name: Release

on:
  schedule:
    - cron: '0 3 * * *'
  workflow_dispatch:

permissions: {}

jobs:
  verify:
    name: Verify Plugin
    runs-on: ubuntu-24.04
    permissions:
      contents: read

    steps:
      - name: Checkout
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1

      - name: Setup mise
        uses: jdx/mise-action@146a28175021df8ca24f8ee1828cc2a60f980bd5 # v3.5.1
        with:
          install: true
          cache: true

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@748248ddd2a24f49513d8f472f81c3a07d4d50e1 # v4.4.4
        with:
          cache-read-only: false

      - name: Run linters
        run: mise run lint

      - name: Verify plugin
        run: ./gradlew verifyPlugin

  release:
    name: Semantic Release
    runs-on: ubuntu-24.04
    needs: verify
    permissions:
      contents: write
      issues: write
      pull-requests: write
    outputs:
      new_release_published: ${{ steps.semantic.outputs.new_release_published }}
      new_release_version: ${{ steps.semantic.outputs.new_release_version }}

    steps:
      - name: Generate App Token
        id: app-token
        uses: actions/create-github-app-token@29824e69f54612133e76f7eaac726eef6c875baf # v2.2.1
        with:
          app-id: ${{ vars.SMYKLOT_APP_ID }}
          private-key: ${{ secrets.SMYKLOT_APP_PRIVATE_KEY }}

      - name: Checkout
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          fetch-depth: 0
          persist-credentials: false

      - name: Setup mise
        uses: jdx/mise-action@146a28175021df8ca24f8ee1828cc2a60f980bd5 # v3.5.1
        with:
          install: true
          cache: true

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@748248ddd2a24f49513d8f472f81c3a07d4d50e1 # v4.4.4
        with:
          cache-read-only: false

      - name: Run semantic-release
        id: semantic
        uses: cycjimmy/semantic-release-action@b12c8f6015dc215fe37bc154d4ad456dd3833c90 # v6.0.0
        with:
          extra_plugins: |
            @semantic-release/changelog
            @semantic-release/exec
            conventional-changelog-conventionalcommits
        env:
          GITHUB_TOKEN: ${{ steps.app-token.outputs.token }}
          JETBRAINS_CERTIFICATE_CHAIN: ${{ secrets.JETBRAINS_CERTIFICATE_CHAIN }}
          JETBRAINS_PRIVATE_KEY: ${{ secrets.JETBRAINS_PRIVATE_KEY }}
          JETBRAINS_PRIVATE_KEY_PASSWORD: ${{ secrets.JETBRAINS_PRIVATE_KEY_PASSWORD }}
          JETBRAINS_MARKETPLACE_TOKEN: ${{ secrets.JETBRAINS_MARKETPLACE_TOKEN }}

      - name: Prepare commit message
        if: steps.semantic.outputs.new_release_published == 'true'
        id: commit-msg
        env:
          VERSION: ${{ steps.semantic.outputs.new_release_version }}
          NOTES: ${{ steps.semantic.outputs.new_release_notes }}
        run: |
          {
            echo 'message<<EOF'
            echo "chore(release): $VERSION"
            echo ""
            echo "$NOTES"
            echo 'EOF'
          } >> "$GITHUB_OUTPUT"

      - name: Commit release assets (signed)
        if: steps.semantic.outputs.new_release_published == 'true'
        id: bot-commit
        uses: iarekylew00t/verified-bot-commit@9bc80191f098974ecf436b05a5cd854525281a49 # v2.0.7
        with:
          token: ${{ steps.app-token.outputs.token }}
          ref: refs/heads/main
          files: |
            CHANGELOG.md
            gradle.properties
          message: ${{ steps.commit-msg.outputs.message }}
          auto-stage: true
          update-local: true
          force-push: false
          if-no-commit: error
          no-throttle: false
          no-retry: false
          max-retries: 3

      - name: Verify commit signature
        if: steps.semantic.outputs.new_release_published == 'true'
        env:
          GH_TOKEN: ${{ steps.app-token.outputs.token }}
          COMMIT_SHA: ${{ steps.bot-commit.outputs.commit }}
          REPO: ${{ github.repository }}
        run: |
          echo "ðŸ” Verifying commit signature for: $COMMIT_SHA"

          verification=$(gh api "repos/$REPO/commits/$COMMIT_SHA" --jq '.commit.verification')
          verified=$(echo "$verification" | jq -r '.verified')
          reason=$(echo "$verification" | jq -r '.reason')

          echo "Verified: $verified"
          echo "Reason: $reason"

          if [ "$verified" != "true" ]; then
            echo "âŒ ERROR: Commit is not verified!" >&2
            echo "Verification: $verification" >&2
            exit 1
          fi

          if [ "$reason" != "valid" ]; then
            echo "âš ï¸  WARNING: Unexpected verification reason: $reason" >&2
          fi

          echo "âœ… Commit signature verified successfully"
